

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดบอลสนาม Jakhong Senior Cup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            background: #111827; /* เทาเข้มแบบเทคโนโลยี */
            color: white;
        }

        /* ---------- Navigation ---------- */
        .nav {
            display: flex;
            gap: 20px;
            padding: 16px 24px;
            background: #1E1E1E;
        }

        .nav-item {
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #B91C1C, #7F1D1D); /* แดงไวน์ */
            color: #FACC15; /* ทอง */
            box-shadow: 0 4px 15px rgba(185, 28, 28, 0.4);
        }

        /* ---------- Card Hover ---------- */
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        /* ---------- Gradient BG (ปรับเป็นแดงทอง) ---------- */
        .gradient-bg {
            background: linear-gradient(135deg, #B91C1C 0%, #7F1D1D 100%);
        }

        /* ---------- Glass Effect ---------- */
        .glass-effect {
            background: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(14px);
            border: 1px solid rgba(250, 204, 21, 0.2); /* ขอบทองจางๆ */
            padding: 30px;
            margin: 30px auto;
            width: 80%;
            border-radius: 20px;
        }

        /* ---------- Alerts ---------- */
        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .success-message {
            background: #16A34A;
            color: white;
        }

        .error-message {
            background: #DC2626;
            color: white;
        }

        .success-message.show, .error-message.show {
            transform: translateX(0);
        }

        /* ---------- Record Type Card ---------- */
        .record-type-card {
            transition: all 0.3s ease;
        }

        .record-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(185, 28, 28, 0.25); /* เงาแดง */
        }

        input[name="record-type"]:checked + .record-type-card {
            border-color: #FACC15; /* ขอบทอง */
            background: rgba(250, 204, 21, 0.1); /* ทองใส */
        }
        
        /* Custom Checkbox for team-color */
        input[name="team-color"]:checked + div {
            border-color: #FACC15; /* Gold border */
            transform: scale(1.05);
        }
        input[name="team-color"]:checked + div > i {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-900 min-h-full">
    <header class="bg-gradient-to-r from-red-800 via-red-700 to-yellow-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-full bg-white bg-opacity-20 flex items-center justify-center">
                        <i class="fas fa-futbol text-2xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">ระบบจัดบอลสนาม Jakhong Senior Cup</h1>
                        <p class="text-yellow-200 text-sm">Football Management System</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm opacity-90" id="current-date"></div>
                    <div class="text-xs opacity-75" id="current-time"></div>
                </div>
            </div>
        </div>
    </header>

   <nav class="glass-effect shadow-lg sticky top-0 z-40 bg-gray-900/80"> 
        <div class="container mx-auto px-4"> 
            <div class="flex overflow-x-auto"> 
                <button class="nav-item active flex items-center space-x-2 px-6 py-4 whitespace-nowrap transition-all" onclick="showSection('dashboard')"> <i class="fas fa-home"></i> 
                    <span>หน้าหลัก</span> </button> 
                <button class="nav-item flex items-center space-x-2 px-6 py-4 whitespace-nowrap transition-all hover:bg-gray-700" onclick="showSection('match-record')"> 
                    <i class="fas fa-edit"></i> <span>บันทึกผล</span> 
                </button> <button class="nav-item flex items-center space-x-2 px-6 py-4 whitespace-nowrap transition-all hover:bg-gray-700" onclick="showSection('player-records')"> 
                    <i class="fas fa-medal"></i> <span>บันทึกสถิติผู้เล่น</span> 
                </button> <button class="nav-item flex items-center space-x-2 px-6 py-4 whitespace-nowrap transition-all hover:bg-gray-700" onclick="showSection('leaderboard')"> 
                    <i class="fas fa-trophy"></i> <span>ตารางคะแนน</span> </button> 
                <button class="nav-item flex items-center space-x-2 px-6 py-4 whitespace-nowrap transition-all hover:bg-gray-700" onclick="showSection('team-management')"> 
                    <i class="fas fa-users"></i> <span>จัดการทีม</span> </button> 
                <button class="nav-item flex items-center space-x-2 px-6 py-4 whitespace-nowrap transition-all hover:bg-gray-700" onclick="showSection('player-list')"> 
                    <i class="fas fa-list"></i> <span>รายชื่อนักกีฬา</span> </button> 
                <button class="nav-item flex items-center space-x-2 px-6 py-4 whitespace-nowrap transition-all hover:bg-gray-700" onclick="showSection('next-matches')"> 
                    <i class="fas fa-calendar-plus"></i> <span>แมทช์ต่อไป</span> </button>
                <button class="nav-item flex items-center space-x-2 px-6 py-4 whitespace-nowrap transition-all hover:bg-gray-700" onclick="showSection('daily-summary')">
                    <i class="fas fa-calendar-day"></i> <span>สรุปตามวันที่</span> </button> </div> </div> 
    </nav>


    <main class="container mx-auto px-4 py-8">
        <div id="dashboard" class="section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-xl shadow-lg p-6 card-hover transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm mb-1">ทีมทั้งหมด</p>
                            <p class="text-3xl font-bold" id="total-teams">0</p>
                            <p class="text-xs text-blue-200 mt-1">ทีมที่ลงทะเบียน</p>
                        </div>
                        <i class="fas fa-users text-3xl opacity-80"></i>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-xl shadow-lg p-6 card-hover transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm mb-1">สมาชิกทั้งหมด</p>
                            <p class="text-3xl font-bold" id="total-players">0</p>
                            <p class="text-xs text-green-200 mt-1">นักกีฬาที่ลงทะเบียน</p>
                        </div>
                        <i class="fas fa-user-friends text-3xl opacity-80"></i>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-xl shadow-lg p-6 card-hover transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm mb-1">แมทช์ทั้งหมด</p>
                            <p class="text-3xl font-bold" id="total-matches">0</p>
                            <p class="text-xs text-purple-200 mt-1">การแข่งขันที่จบแล้ว</p>
                        </div>
                        <i class="fas fa-futbol text-3xl opacity-80"></i>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-yellow-500 to-orange-600 text-white rounded-xl shadow-lg p-6 card-hover transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-100 text-sm mb-1">ผู้นำลีก</p>
                            <p class="text-lg font-bold" id="league-leader-name">-</p>
                            <p class="text-sm text-yellow-100" id="league-leader-points">0 คะแนน</p>
                        </div>
                        <i class="fas fa-crown text-3xl opacity-80"></i>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="glass-effect rounded-xl shadow-lg p-6 card-hover transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm mb-1">แมทช์สัปดาห์นี้</p>
                            <p class="text-2xl font-bold text-indigo-400" id="matches-this-week">0</p>
                        </div>
                        <i class="fas fa-calendar-week text-2xl text-indigo-500"></i>
                    </div>
                </div>

                <div class="glass-effect rounded-xl shadow-lg p-6 card-hover transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm mb-1">ทีมยอดนิยมเดือนนี้</p>
                            <p class="text-lg font-bold text-pink-400" id="top-team-month">-</p>
                        </div>
                        <i class="fas fa-fire text-2xl text-pink-500"></i>
                    </div>
                </div>

                <div class="glass-effect rounded-xl shadow-lg p-6 card-hover transition-all">
                    <div id="goals-stats" class="flex justify-between text-white">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-400">0</div>
                            <div class="text-sm text-gray-400">ประตูรวม</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-400">0</div>
                            <div class="text-sm text-gray-400">เฉลี่ย/แมทช์</div>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-xl shadow-lg p-6 card-hover transition-all">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm mb-1">สถิติผู้เล่น</p>
                            <p class="text-2xl font-bold text-teal-400" id="total-player-records">0</p>
                            <p class="text-xs text-gray-500 mt-1">บันทึกทั้งหมด</p>
                        </div>
                        <i class="fas fa-chart-bar text-2xl text-teal-500"></i>
                    </div>
                </div>
            </div>

            <div class="glass-effect rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold mb-6 flex items-center text-white">
                    <i class="fas fa-user-tie mr-3 text-purple-500"></i>
                    ผู้จัดการทีม
                </h3>
                <div id="team-managers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
            </div>

            <div class="glass-effect rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold mb-6 text-white flex items-center">
                    <i class="fas fa-clock mr-3 text-blue-500"></i>
                    แมทช์ล่าสุด
                </h3>
                <div id="recent-matches-list" class="space-y-4">
                    </div>
            </div>
        </div>

        <div id="match-record" class="section hidden">
            <div class="glass-effect rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center text-white">
                    <i class="fas fa-edit mr-3 text-blue-500"></i>
                    บันทึกผลการแข่งขัน
                </h2>
                <form class="space-y-6" onsubmit="handleMatchSubmit(event)">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">วันที่แข่งขัน *</label>
                        <input type="date" id="match-date" class="w-full border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-800 text-white" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ทีมเจ้าบ้าน *</label>
                            <select id="team-a" class="w-full border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-800 text-white" required>
                                <option value="">เลือกทีม</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ทีมเยือน *</label>
                            <select id="team-b" class="w-full border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-800 text-white" required>
                                <option value="">เลือกทีม</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-blue-900/30 rounded-lg p-6 border-2 border-blue-600">
                        <h3 class="font-bold text-lg mb-4 text-center text-blue-400">ผลการแข่งขัน</h3>
                        <div class="flex items-center justify-center space-x-8">
                            <div class="text-center">
                                <div class="mb-2 font-medium text-blue-300">ทีมเจ้าบ้าน</div>
                                <input type="number" id="score-a" min="0" max="99" class="w-24 h-20 text-center text-3xl font-bold border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 bg-gray-900 text-yellow-400 shadow-xl" required>
                            </div>
                            <div class="text-4xl font-extrabold text-red-500">VS</div>
                            <div class="text-center">
                                <div class="mb-2 font-medium text-blue-300">ทีมเยือน</div>
                                <input type="number" id="score-b" min="0" max="99" class="w-24 h-20 text-center text-3xl font-bold border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 bg-gray-900 text-yellow-400 shadow-xl" required>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-gradient-to-r from-blue-600 to-blue-800 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-blue-900 transition-all font-medium">
                            <i class="fas fa-save mr-2"></i>
                            บันทึกผลการแข่งขัน
                        </button>
                        <button type="button" onclick="clearMatchForm()" class="bg-gray-600 text-white py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-eraser mr-2"></i>
                            ล้างฟอร์ม
                        </button>
                    </div>
                </form>
            </div>

            <div class="glass-effect rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold mb-6 text-white">ประวัติการแข่งขัน</h3>
                <div class="space-y-4" id="match-history-list">
                    </div>
            </div>
        </div>

        <div id="leaderboard" class="section hidden">
            </div>

        <div id="team-management" class="section hidden">
            <div class="glass-effect rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold mb-6 flex items-center text-white">
                    <i class="fas fa-users mr-3 text-blue-500"></i>
                    เพิ่มทีมใหม่
                </h2>
                
                <form class="space-y-6" onsubmit="handleTeamSubmit(event)">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ชื่อทีม *</label>
                        <input type="text" id="team-name" placeholder="กรอกชื่อทีม เช่น ทีมสิงห์, ทีมเสือ" 
                               class="w-full border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-800 text-white" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">โลโก้ทีม</label>
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="relative">
                                <input type="file" id="team-logo" accept="image/*" class="sr-only" onchange="handleLogoUpload(event)">
                                <label for="team-logo" class="cursor-pointer flex items-center justify-center w-20 h-20 border-2 border-dashed border-gray-500 rounded-lg hover:border-blue-500 transition-colors">
                                    <div id="logo-preview" class="w-full h-full rounded-lg bg-gray-700 flex items-center justify-center">
                                        <i class="fas fa-camera text-gray-400 text-xl"></i>
                                    </div>
                                </label>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm text-gray-300 mb-1">อัพโหลดโลโก้ทีม (ไม่บังคับ)</p>
                                <p class="text-xs text-gray-400">รองรับไฟล์ JPG, PNG ขนาดไม่เกิน 2MB</p>
                                <button type="button" id="remove-logo" onclick="removeLogo()" class="text-red-500 text-xs mt-1 hidden">ลบโลโก้</button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-3">สีประจำทีม *</label>
                        <div class="grid grid-cols-8 gap-3">
                            </div>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-blue-900 transition-all font-medium">
                        <i class="fas fa-plus-circle mr-2"></i>
                        เพิ่มทีม
                    </button>
                </form>
            </div>

            <div class="glass-effect rounded-xl shadow-lg p-6 border-2 border-red-600 bg-red-900/30 mt-8">
                <h2 class="text-2xl font-bold mb-4 flex items-center text-red-400">
                    <i class="fas fa-exclamation-triangle mr-3"></i>
                    ระบบล้างข้อมูล (อันตราย)
                </h2>
                <p class="text-sm text-gray-300 mb-4">
                    การกระทำนี้จะลบข้อมูลทั้งหมดที่บันทึกไว้ในเบราว์เซอร์ของคุณ (ทีม, ผู้เล่น, แมทช์, สถิติ) **ข้อมูลจะไม่สามารถกู้คืนได้**
                </p>
                <button type="button" onclick="confirmClearAllData()" class="w-full bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 transition-all font-medium flex items-center justify-center">
                    <i class="fas fa-trash-alt mr-2"></i>
                    ลบข้อมูลทั้งหมดอย่างถาวร
                </button>
            </div>
            </div>

        <div id="player-list" class="section hidden">
            <h2 class="text-2xl font-bold mb-6 flex items-center text-white">
                <i class="fas fa-list-alt mr-3 text-yellow-500"></i>
                รายชื่อนักกีฬาและสถิติ
            </h2>
            
            <div id="players-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                </div>
        </div>

        </main>

    <div id="modal-container"></div>
    <div id="success-message" class="success-message"></div>
    <div id="error-message" class="error-message"></div>


    <script>
        // --- DATA STRUCTURES (Assumed to be defined) ---
        let teams = JSON.parse(localStorage.getItem('jakhongSeniorTeams')) || [];
        let players = JSON.parse(localStorage.getItem('jakhongSeniorPlayers')) || [];
        let matches = JSON.parse(localStorage.getItem('jakhongSeniorMatches')) || [];
        let playerRecords = JSON.parse(localStorage.getItem('jakhongSeniorPlayerRecords')) || [];
        let nextMatches = JSON.parse(localStorage.getItem('jakhongSeniorNextMatches')) || [];

        // --- UTILITY FUNCTIONS (Partial/Reconstructed) ---

        function saveData(key) {
            const dataMap = {
                teams: teams,
                players: players,
                matches: matches,
                playerRecords: playerRecords,
                nextMatches: nextMatches
            };
            if (dataMap[key]) {
                localStorage.setItem(`jakhongSenior${key.charAt(0).toUpperCase() + key.slice(1)}`, JSON.stringify(dataMap[key]));
            }
        }
        
        function getTeamById(id) { return teams.find(t => t.id === id); }
        function getPlayerById(id) { return players.find(p => p.id === id); }
        function showSuccessMessage(message) { /* ... implementation ... */ }
        function showErrorMessage(message) { /* ... implementation ... */ }
        
        // --- showDeleteModal RECONSTRUCTION (Crucial for clearAllData) ---
        function showDeleteModal(message, detailsHTML, onConfirm) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 shadow-2xl max-w-sm w-full">
                        <h3 class="text-xl font-bold text-red-600 mb-4">${message}</h3>
                        <div class="text-sm text-gray-700 mb-6">
                            ${detailsHTML}
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                ยกเลิก
                            </button>
                            <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                ยืนยันการลบ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('confirm-delete-btn').onclick = () => {
                onConfirm();
                closeModal();
            };
            document.body.classList.add('overflow-hidden');
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
            document.body.classList.remove('overflow-hidden');
        }


        // --- NEW/MODIFIED FUNCTIONS ---

        // แก้ไข: เพิ่มระบบล้างข้อมูลทั้งหมด
        function clearAllData() {
            localStorage.removeItem('jakhongSeniorTeams');
            localStorage.removeItem('jakhongSeniorPlayers');
            localStorage.removeItem('jakhongSeniorMatches');
            localStorage.removeItem('jakhongSeniorPlayerRecords');
            localStorage.removeItem('jakhongSeniorNextMatches');

            // Reset in-memory arrays and reload UI
            teams = [];
            players = [];
            matches = [];
            playerRecords = [];
            nextMatches = [];

            // Reload/Update all UI components
            // Assuming loadFromDatabase() re-initializes (though here we just reset everything)
            // We need to re-call all update functions
            updateTeamsList();
            updatePlayersList();
            updateLeaderboard();
            updateMatchHistory();
            updatePlayerRecordsList();
            updateTopPlayersStats(); // Assumed function
            updateDashboardStats(); // Assumed function
            updateNextMatchesList(); // Assumed function
            updateDailySummary(); // Assumed function
            
            showSection('dashboard');
            showSuccessMessage('ล้างข้อมูลทั้งหมดสำเร็จแล้ว! ระบบถูกรีเซ็ต.');
        }

        function confirmClearAllData() {
            const message = '⚠️ คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลทั้งหมด?';
            const details = `
                <div class="text-red-600 font-bold mt-2">
                    <i class="fas fa-exclamation-circle mr-1"></i> การลบนี้จะนำข้อมูล ทีม, ผู้เล่น, แมทช์, และสถิติทั้งหมดออกจากเบราว์เซอร์ของคุณ
                </div>
                <div class="text-sm text-gray-500 mt-1">
                    **ข้อมูลจะไม่สามารถกู้คืนได้** กรุณาตรวจสอบให้แน่ใจก่อนดำเนินการ
                </div>
            `;
            showDeleteModal(message, details, clearAllData);
        }

        // --- getPlayerStats RECONSTRUCTION (Needed for Player Card) ---
        function getPlayerStats(playerId) {
            const player = getPlayerById(playerId);
            if (!player) return null;

            const playerRecs = playerRecords.filter(r => r.playerId === playerId);
            const goals = playerRecs.filter(r => r.type === 'goal').reduce((sum, r) => sum + r.count, 0);
            const assists = playerRecs.filter(r => r.type === 'assist').reduce((sum, r) => sum + r.count, 0);
            const saves = playerRecs.filter(r => r.type === 'save').reduce((sum, r) => sum + r.count, 0);
            const yellows = playerRecs.filter(r => r.type === 'yellow').length;
            const reds = playerRecs.filter(r => r.type === 'red').length;
            
            // Simplified performance score: Goals (3pts) + Assists (2pts) + Saves (1pt) - Reds (5pts)
            const score = (goals * 3) + (assists * 2) + saves - (reds * 5);

            return {
                player,
                goals,
                assists,
                saves,
                yellows,
                reds,
                score
            };
        }

        // --- getColorClass and getAge (Needed for Player Card) ---
        function getColorClass(color) {
             const map = {
                'red': 'bg-red-500', 'blue': 'bg-blue-500', 'green': 'bg-green-500', 'yellow': 'bg-yellow-400', 
                'purple': 'bg-purple-500', 'orange': 'bg-orange-500', 'pink': 'bg-pink-500', 'indigo': 'bg-indigo-500', 
                'teal': 'bg-teal-500', 'cyan': 'bg-cyan-500', 'lime': 'bg-lime-500', 'rose': 'bg-rose-500', 
                'amber': 'bg-amber-500', 'emerald': 'bg-emerald-500', 'violet': 'bg-violet-500', 'fuchsia': 'bg-fuchsia-500',
                'white': 'bg-white text-gray-800 border border-gray-300', 'black': 'bg-black'
            };
            return map[color] || 'bg-gray-500';
        }

        function getAge(birthdate) {
            if (!birthdate) return '?';
            const today = new Date();
            const birthDate = new Date(birthdate);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }


        // แก้ไข: ปรับปรุงการ์ดนักกีฬา (updatePlayersList function)
        function updatePlayersList() {
            const container = document.getElementById('players-list-container');
            if (!container) return;
            
            // Re-using filtering logic (assuming getFilteredPlayers exists)
            let filteredPlayers = players.map(p => getPlayerStats(p)).filter(Boolean);

            if (filteredPlayers.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-8 text-gray-500">
                        <i class="fas fa-users text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg font-medium">ยังไม่มีผู้เล่น</p>
                        <p class="text-sm">เริ่มต้นด้วยการเพิ่มผู้เล่นแรก</p>
                    </div>
                `;
                return;
            }

            // Sort by performance score
            filteredPlayers.sort((a, b) => b.score - a.score);

            container.innerHTML = filteredPlayers.map((stats, index) => {
                const player = stats.player;
                const team = getTeamById(player.teamId);
                const age = getAge(player.birthdate);
                
                // Determine card color based on performance rank
                let cardClass = 'bg-gray-800/80';
                let rankBadge = '';

                if (index === 0) {
                    cardClass = 'bg-gradient-to-br from-yellow-700 to-amber-500 text-white';
                    rankBadge = `<div class="absolute -top-3 -right-3 w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center border-2 border-white shadow-lg"><i class="fas fa-crown text-sm text-white"></i></div>`;
                } else if (index === 1) {
                    cardClass = 'bg-gradient-to-br from-gray-600 to-gray-400 text-white';
                    rankBadge = `<div class="absolute -top-3 -right-3 w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center border-2 border-white shadow-lg"><i class="fas fa-medal text-sm text-gray-800"></i></div>`;
                } else if (index === 2) {
                    cardClass = 'bg-gradient-to-br from-yellow-800 to-yellow-600 text-white';
                    rankBadge = `<div class="absolute -top-3 -right-3 w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center border-2 border-white shadow-lg"><i class="fas fa-medal text-sm text-yellow-900"></i></div>`;
                }

                const playerAvatar = player.photo ? 
                    `<img src="${player.photo}" alt="${player.name}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg">` : 
                    `<div class="w-24 h-24 rounded-full ${team ? getColorClass(team.primaryColor) : 'bg-gray-500'} flex items-center justify-center text-white font-bold text-3xl border-4 border-white shadow-lg"> ${player.name.charAt(0)} </div>`;

                // Performance Level
                let performanceLevel = 'มือใหม่';
                let performanceColor = 'text-gray-400';
                let performanceIcon = 'fas fa-star-half-alt';
                let scoreColor = 'text-yellow-400';

                if (stats.score >= 10) {
                    performanceLevel = 'MVP';
                    performanceColor = 'text-red-400';
                    performanceIcon = 'fas fa-trophy';
                    scoreColor = 'text-red-400';
                } else if (stats.score >= 5) {
                    performanceLevel = 'มือดี';
                    performanceColor = 'text-indigo-400';
                    performanceIcon = 'fas fa-thumbs-up';
                    scoreColor = 'text-indigo-400';
                }

                const teamInfo = team ? `
                    <div class="flex items-center space-x-2 text-sm text-gray-400 mt-1">
                        ${team.logo ? `<img src="${team.logo}" class="w-4 h-4 rounded-full">` : `<div class="w-4 h-4 rounded-full ${getColorClass(team.primaryColor)}"></div>`}
                        <span class="font-medium">${team.name}</span>
                        ${player.jersey ? `<span class="font-bold ml-2 text-yellow-400">#${player.jersey}</span>` : ''}
                    </div>
                ` : `<p class="text-sm text-gray-500">ไม่มีทีม</p>`;


                return `
                    <div class="${cardClass} rounded-2xl shadow-xl border border-gray-700 p-6 card-hover transition-all">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-1 text-sm font-bold ${performanceColor}">
                                <i class="${performanceIcon} text-base"></i>
                                <span class="text-xs font-bold">${performanceLevel}</span>
                            </div>
                            <span class="text-lg font-bold text-gray-400">อันดับ #${index + 1}</span>
                        </div>
                        
                        <div class="flex flex-col items-center text-center mb-6">
                            <div class="relative mb-4">
                                ${playerAvatar}
                                ${rankBadge}
                            </div>
                            <h4 class="text-xl font-bold mb-1 text-white">${player.name}</h4>
                            ${teamInfo}
                            <p class="text-xs text-gray-500 mt-1">${player.role || 'นักกีฬา'} ${player.birthdate ? `| ${age} ปี` : ''}</p>
                        </div>
                        
                        <div class="bg-gray-900/50 rounded-xl px-4 py-3 shadow-inner mt-4 border border-gray-700">
                            <div class="text-center mb-3">
                                <div class="text-3xl font-extrabold ${scoreColor}">${stats.score}</div>
                                <div class="text-xs text-gray-500">คะแนนรวมประสิทธิภาพ</div>
                            </div>
                            <div class="grid grid-cols-3 gap-3 text-center text-white">
                                <div>
                                    <div class="text-lg font-bold text-green-400">${stats.goals}</div>
                                    <div class="text-xs text-gray-400"><i class="fas fa-futbol mr-1"></i>ประตู</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-blue-400">${stats.assists}</div>
                                    <div class="text-xs text-gray-400"><i class="fas fa-handshake mr-1"></i>แอสซิสต์</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-cyan-400">${stats.saves}</div>
                                    <div class="text-xs text-gray-400"><i class="fas fa-hand-paper mr-1"></i>เซฟ</div>
                                </div>
                            </div>
                            <div class="flex justify-center space-x-4 mt-3">
                                ${stats.yellows > 0 ? `<div class="flex items-center text-sm font-bold text-yellow-400"><i class="fas fa-square mr-1 text-yellow-500"></i> ${stats.yellows}</div>` : ''}
                                ${stats.reds > 0 ? `<div class="flex items-center text-sm font-bold text-red-500"><i class="fas fa-square mr-1 text-red-600"></i> ${stats.reds}</div>` : ''}
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-700 mt-4">
                            <div class="flex space-x-3">
                                <button onclick="editPlayer(${player.id}); event.stopPropagation();" class="flex-1 flex items-center justify-center py-2 px-4 bg-blue-700/50 hover:bg-blue-700 text-blue-300 rounded-lg transition-colors font-medium text-sm" title="แก้ไขผู้เล่น">
                                    <i class="fas fa-edit mr-2"></i> แก้ไข
                                </button>
                                <button onclick="deletePlayer(${player.id}); event.stopPropagation();" class="flex-1 flex items-center justify-center py-2 px-4 bg-red-700/50 hover:bg-red-700 text-red-300 rounded-lg transition-colors font-medium text-sm" title="ลบผู้เล่น">
                                    <i class="fas fa-trash-alt mr-2"></i> ลบ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // --- Dummy Functions for UI refresh (must be implemented for full functionality) ---
        function showSection(sectionId) { 
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'bg-red-700');
                item.classList.add('hover:bg-gray-700');
            });
            document.querySelector(`.nav-item[onclick*='${sectionId}']`).classList.add('active');
        }
        function updateTeamsList() {}
        function updateLeaderboard() {}
        function updateMatchHistory() {}
        function updatePlayerRecordsList() {}
        function updateTopPlayersStats() {}
        function updateDashboardStats() {}
        function updateNextMatchesList() {}
        function updateDailySummary() {}
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load all data here (assumed to be done at start of JS block)
            // Call initial UI updates
            updatePlayersList(); 
            showSection('dashboard');
            // ... other initial calls
        });

    </script>
</body>
</html>
